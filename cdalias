#!/usr/local/bin/bash
read -r -d '' HELP << EndOfHelp
------------------------------------------------------
cdalias is a script which creates directory aliases 
for the  bash cd builtin.Aliases are stored in the 
file pointed to by CDDICTFILE or \$HOME/.cdaliases if not
 set. The format of this file is simple:

	 alias definition # Comment
 
 Comments may also be placed at the beginning of the 
 line and those lines, as well as blank lines, are 
 ignored entirely.

 Additional options have been added to the cd command:
		-a alias definition - store new alias definition 
		                      and exit  
		-list  list the directory aliases and exit
		-o     cd will act like popd, although directory 
		       aliases are then irrelevant
		-p     cd will act like pushd
		-r alias removes the alias.
		-h 	   Will display the internal help for cd, 
		       then help on these options and exit

 To use, declare and export a bash function as below:
 function cd() { eval \$(~/bin/cdalias \$@); } ; export -f cd

 Once this is put in place, you may use cd as you always do 
 with the additional benefit of being able to type cd <alias> 
 and get to the place pointed by <alias>

 The built-in aliases, when there is no dictionary file, are:
 	...	gets to the parent of the parent, or ../..
 	.... gets to the parent of the parent of the parent, or ../../..

.
EndOfHelp

dictfile=${CDDICTFILE:="$HOME/.cdaliases"}
declare -A cdict=(["____foo"]="bar")

function writealiases() {
	fdata="## Aliases generated by cdaliases\n"
	for key in ${!cdict[@]} ; do
		fdata="${fdata}${key} ${cdict[$key]}\n"
	done
	echo -e "${fdata}">$dictfile
}

if [ ! -f "$dictfile" ] ; then
	cdict['...']='../..'
	cdict['....']='../../..'
else
	sdata=""
	while read -r key val ; do
		key="${key%%\#*}"
		val="${val%%\#*}"
		[ -n "$key" ] && [ -n "$val" ] && cdict["$key"]="$val"
	done < $dictfile ## No sub-shell, so variables remain set. 
fi
unset cdict["____foo"]
cdargs=""
cmd="cd"
case "$1" in
	"-a" )
		if [ -n "$2" ] && [ -n "$3" ] ; then
			cdict["$2"]="$3"
			writealiases
		else
			echo "Usage: -a key value" >&2
		fi
		exit
		;;
	"-r" | "--remove")
		[ -z "$2" ] && { echo "Usage: cd -r <alias>" >&2; exit 1;}
		if [ -n "${cdict["$2"]}" ] ; then
			unset cdict["$2"] && { echo "Alias for $2 removed." >&2; writealiases; exit 0;}
		else
			echo "$2: not found" >&2;
			exit 1;
		fi
		exit;;
	"-p" )
		cmd="pushd"
		shift
		;;
	"-o")
		cmd="popd"
		shift
		;;
	"-list"| "--list")
		(echo "Alias list:";
		for a in ${!cdict[@]}; do
			echo "    \"$a\" is an alias for \"${cdict[$a]}\""
		done) >&2
		exit
		;;
	"-h" | "--help")
		echo -e "This is help for cdalias. For help with the regular cd options use 'help cd'\n$HELP" >&2 
		exit
		;;
esac

for a in $@; do
	[ -n "${cdict[$a]}" ] && a="${cdict[$a]}"
	echo "$a" | grep -q '^\$' && a="${x#?}"
	cdargs="${cdargs} ${a}" 
done
echo "command ${cmd} ${cdargs}"

